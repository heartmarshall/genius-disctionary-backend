# MyEnglish Backend v4 — Карта бизнес-сценариев

> **Дата:** 2026-02-12
> **Назначение:** Полный перечень пользовательских сценариев, привязанных к сервисам. Используется как чеклист при написании спецификаций каждого сервиса.

---

## Auth Service

| # | Сценарий | Описание |
|---|----------|----------|
| A1 | Первый вход (регистрация) | Пользователь входит через Google/Apple впервые → создаётся аккаунт + дефолтные настройки → выдаётся JWT-пара |
| A2 | Повторный вход | Пользователь входит через Google/Apple → аккаунт найден → обновляются name/avatar если изменились → выдаётся JWT-пара |
| A3 | Обновление access token | Access token истёк → клиент отправляет refresh token → выдаётся новая JWT-пара, старый refresh token отзывается (token rotation) |
| A4 | Logout | Пользователь выходит → все refresh tokens отзываются (logout everywhere) |
| A5 | Валидация токена | Middleware проверяет JWT access token при каждом запросе (без обращения к БД) |
| A6 | Cleanup expired tokens | Периодическая задача: удаление expired и revoked refresh tokens |

---

## Dictionary Service

| # | Сценарий | Описание |
|---|----------|----------|
| D1 | Поиск слова в каталоге | Пользователь вводит текст → fuzzy search по Reference Catalog → список совпадений для autocomplete |
| D2 | Просмотр ref_entry (preview) | Пользователь выбирает слово из результатов поиска → загружается полное дерево ref_entry (senses, translations, examples, pronunciations, images) → отображается в конструкторе для выбора |
| D3 | Добавление слова из каталога | Пользователь выбирает нужные senses/translations/examples → создаётся entry со ссылками на ref-данные + опционально карточка |
| D4 | Добавление слова вручную (custom) | Пользователь вводит слово + определения/переводы/примеры вручную → создаётся entry без ref_entry_id, все данные в user-полях |
| D5 | Поиск в своём словаре | Пользователь ищет слово в своём словаре по тексту (ILIKE) |
| D6 | Фильтрация словаря | Пользователь фильтрует свой словарь по: наличию карточки, part of speech, топику, статусу изучения. Любая комбинация фильтров. |
| D7 | Просмотр слова | Пользователь открывает слово → видит все senses, translations, examples, pronunciations, images (COALESCE из ref + user), notes, topics, card status |
| D8 | Редактирование заметок | Пользователь добавляет/изменяет notes к слову |
| D9 | Удаление слова (soft delete) | Пользователь удаляет слово → soft delete, слово скрывается из словаря и очереди повторения |
| D10 | Просмотр удалённых слов | Пользователь просматривает список soft-deleted записей (корзина) |
| D11 | Восстановление слова | Пользователь восстанавливает soft-deleted слово → оно снова видимо в словаре и очереди |
| D12 | Импорт словаря из файла | Пользователь загружает файл (CSV/JSON) → массовое создание entries (chunks по 50, partial failure) → отчёт: imported/skipped/errors |
| D13 | Экспорт словаря | Пользователь запрашивает экспорт → генерируется файл (CSV/JSON) со всеми entries + senses + translations + examples + card status |

---

## Content Service

| # | Сценарий | Описание |
|---|----------|----------|
| C1 | Добавление значения (sense) | Пользователь добавляет новое значение к слову (definition, part_of_speech, cefr_level, translations) |
| C2 | Редактирование значения | Пользователь изменяет definition/pos/cefr у sense → partial customization поверх каталога (ref_sense_id не трогается) |
| C3 | Удаление значения | Пользователь удаляет sense → CASCADE удаляет дочерние translations, examples |
| C4 | Добавление перевода | Пользователь добавляет свой перевод к значению |
| C5 | Редактирование перевода | Пользователь изменяет текст перевода (ref link сохраняется) |
| C6 | Удаление перевода | Пользователь удаляет перевод |
| C7 | Добавление примера | Пользователь добавляет свой пример (sentence + translation) |
| C8 | Редактирование примера | Пользователь изменяет текст примера |
| C9 | Удаление примера | Пользователь удаляет пример |
| C10 | Изменение порядка (reorder) | Пользователь меняет порядок senses / translations / examples перетаскиванием |
| C11 | Добавление своего изображения | Пользователь добавляет user_image к слову (URL + caption) |
| C12 | Удаление своего изображения | Пользователь удаляет user_image |

---

## Study Service

| # | Сценарий | Описание |
|---|----------|----------|
| S1 | Получение очереди изучения | Пользователь открывает study session → получает карточки: overdue first, then new. С учётом daily limits (new_cards_per_day, reviews_per_day) |
| S2 | Review карточки | Пользователь оценивает карточку (AGAIN/HARD/GOOD/EASY) → SRS пересчитывает interval, ease, status, next_review_at → создаётся review_log |
| S3 | Dashboard | Пользователь видит: due count, new count, reviewed today, streak, карточки по статусам (NEW/LEARNING/REVIEW/MASTERED) |
| S4 | Создание карточки | Пользователь создаёт карточку для слова, у которого её ещё нет |
| S5 | Удаление карточки | Пользователь удаляет карточку (слово остаётся в словаре, но не появляется в очереди) |
| S6 | История карточки | Пользователь просматривает полную историю reviews конкретной карточки: все grades, даты, durations, график прогресса |
| S7 | Статистика карточки | Пользователь видит статистику карточки: total reviews, accuracy rate (% GOOD+EASY), average duration, текущий interval/ease |
| S8 | Массовое создание карточек | Пользователь выбирает несколько entries → создаёт карточки для всех (пропуская entries, у которых карточка уже есть) |

---

## Inbox Service

| # | Сценарий | Описание |
|---|----------|----------|
| I1 | Быстрое сохранение | Пользователь сохраняет текст (слово/фразу) + опциональный контекст "на потом" |
| I2 | Просмотр inbox | Пользователь видит список inbox items (paginated, newest first) |
| I3 | Обработка inbox item | Пользователь просматривает item → решает добавить в словарь (вызывает Dictionary.CreateEntry отдельно) → удаляет item. Две отдельные операции, не атомарные. |
| I4 | Удаление item | Пользователь удаляет один inbox item |
| I5 | Очистка inbox | Пользователь удаляет все inbox items разом |

---

## Topic Service

| # | Сценарий | Описание |
|---|----------|----------|
| T1 | Создание темы | Пользователь создаёт тему (name + description) |
| T2 | Редактирование темы | Пользователь изменяет name/description |
| T3 | Удаление темы | Пользователь удаляет тему → entries не затрагиваются, только M2M связи |
| T4 | Просмотр тем | Пользователь видит список своих тем (sorted by name) |
| T5 | Привязка слова к теме | Пользователь добавляет entry в тему |
| T6 | Отвязка слова от темы | Пользователь убирает entry из темы |
| T7 | Массовая привязка к теме | Пользователь выбирает несколько entries → присваивает тему всем разом |
| T8 | Фильтрация словаря по теме | Пользователь выбирает тему → видит только entries этой темы (реализуется через Dictionary.Find с topicID) |

---

## RefCatalog Service

| # | Сценарий | Описание |
|---|----------|----------|
| R1 | Fuzzy search | Пользователь вводит текст → fuzzy search по ref_entries (pg_trgm) → список совпадений для autocomplete |
| R2 | Получение полного дерева | Загрузка ref_entry со всеми senses → translations, examples; pronunciations; images. Для конструктора при добавлении слова. |
| R3 | Fetch из внешнего API | Слово отсутствует в каталоге → вызов FreeDictionary/Google Translate → сохранение в ref-таблицы → возврат ref_entry |
| R4 | Concurrent-safe upsert | Два пользователя ищут одно слово одновременно → оба вызывают provider → INSERT ON CONFLICT DO NOTHING + SELECT → без ошибок |

---

## User Service

| # | Сценарий | Описание |
|---|----------|----------|
| U1 | Просмотр профиля | Пользователь видит свои данные (name, email, avatar) |
| U2 | Редактирование профиля | Пользователь изменяет name/avatar |
| U3 | Просмотр настроек | Пользователь видит: new_cards_per_day, reviews_per_day, max_interval_days, timezone |
| U4 | Изменение настроек | Пользователь изменяет параметры изучения. Partial update — только изменённые поля |

---

## Batch / Mass Operations (cross-service)

| # | Сценарий | Сервис | Описание |
|---|----------|--------|----------|
| B1 | Массовое удаление entries | Dictionary | Пользователь выбирает несколько entries → soft delete всех |
| B2 | Массовое создание карточек | Study | Пользователь выбирает несколько entries → создаёт карточки, пропуская entries с карточкой |
| B3 | Массовая привязка к теме | Topic | Пользователь выбирает несколько entries → привязывает к теме (ON CONFLICT DO NOTHING) |
| B4 | Импорт из файла | Dictionary | CSV/JSON → chunks по 50 → partial failure → отчёт |
| B5 | Экспорт в файл | Dictionary | Все entries + content + card status → CSV/JSON |

---

## Периодические задачи (background)

| # | Задача | Описание |
|---|--------|----------|
| BG1 | Hard delete entries | Entries с deleted_at > 30 days → физическое удаление (CASCADE) |
| BG2 | Cleanup tokens | Expired + revoked refresh tokens → DELETE |
| BG3 | Cleanup audit | audit_log старше 1 года → DELETE |

---

## Явно вне scope MVP (зафиксировано для будущего)

| # | Сценарий | Причина |
|---|----------|---------|
| F1 | Social features ("кто ещё учит это слово", популярные переводы) | Инфраструктура готова (origin links, ix_entries_user_ref), но нет бизнес-требований на MVP |
| F2 | Удаление аккаунта | ON DELETE CASCADE готов. Реализовать когда будут требования по privacy/GDPR |
| F3 | AI suggestions (генерация примеров, изображений через OpenAI) | Provider infrastructure готова (source_slug). Отдельный модуль post-MVP |
| F4 | Управление сессиями (просмотр/отзыв конкретной сессии) | token_repo.RevokeByID готов. UI/UX не определён |
| F5 | Source slug display / filtering | Данные маркированы source_slug. UI для отображения источника — post-MVP |

---
