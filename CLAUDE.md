# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Structure

Monorepo with two main directories:
- **`backend_v4/`** — Go backend (the primary codebase)
- **`frontend/`** — React 19 + TypeScript + Vite + Tailwind CSS 4

All commands below should be run from `backend_v4/`.

## Common Commands

```bash
# Build & Run
make build              # Build binary to bin/server
make run                # Run server (go run)

# Tests
make test               # All unit tests (race detector, no cache)
make test-integration   # Integration tests (require Docker)
make test-e2e           # E2E tests via testcontainers

# Single test
go test ./internal/service/study/ -run TestSRSCalculation -race -count=1

# Code generation (sqlc + gqlgen)
make generate

# Linting
make lint               # golangci-lint (config: .golangci.yml)

# Database
make docker-up          # Start PostgreSQL via docker-compose
make migrate-up         # Apply migrations (goose)
make migrate-down       # Rollback last migration
make migrate-create name=add_foo  # New migration file

# Tools are managed via go tool (go.mod tool directive)
go tool goose ...       # Migration runner
go tool sqlc ...        # SQL code generator
```

## Architecture

Hexagonal/Clean Architecture in `backend_v4/internal/`:

```
cmd/server/main.go          → entrypoint (signal handling only)
internal/app/app.go          → full wiring: config → repos → services → transport → server
internal/domain/             → entities, enums, sentinel errors, validation
internal/service/            → business logic (8 services, interface-based deps)
internal/transport/graphql/  → gqlgen resolvers + dataloader middleware
internal/transport/rest/     → health probes + auth REST endpoints
internal/transport/middleware/ → composable middleware chain
internal/adapter/postgres/   → per-entity repo packages with sqlc
internal/adapter/provider/   → external APIs (FreeDictionary, Google OAuth)
internal/auth/               → JWT (HS256) + refresh token hashing
internal/config/             → cleanenv loader (ENV > YAML > defaults)
pkg/ctxutil/                 → type-safe context helpers (UserID, RequestID)
migrations/                  → goose SQL migrations
tests/e2e/                   → full-stack E2E tests (build tag: e2e)
```

### Key Wiring Flow (app.go)

Config → DB Pool → TxManager → Repos (15) → Providers → JWT/OAuth → Services (8) → GraphQL Schema + REST Handlers → Middleware Chain → HTTP Server

### Services

| Service | Purpose |
|---------|---------|
| `auth` | Register, login (password/OAuth), token refresh/logout |
| `user` | Profile + settings (SRS params, timezone) |
| `refcatalog` | Fetch/cache reference entries from FreeDictionary API |
| `dictionary` | Entry CRUD, import/export, catalog integration |
| `content` | Nested editing: senses → translations/examples/images with reordering |
| `study` | SRS flashcard queue, review, undo, sessions, dashboard |
| `topic` | Topic CRUD, entry linking |
| `inbox` | Inbox item management |

### Transport

- **GraphQL** (`POST /query`): All dictionary/content/study/topic/inbox operations. Schema files in `schema/*.graphql`. Resolvers auto-generated by gqlgen, field resolvers use dataloaders to avoid N+1.
- **REST**: Auth endpoints (`/auth/*`) and health probes (`/live`, `/ready`, `/health`).
- **Auth flow**: Bearer token in `Authorization` header → middleware validates JWT → `ctxutil.WithUserID(ctx)` → services extract user from context.

### Database Patterns

- **sqlc** for static queries (per-entity `sqlc.yaml` + `query/*.sql` → `sqlc/` generated code)
- **Squirrel** for dynamic queries (filtering, cursor pagination)
- **TxManager**: `RunInTx(ctx, fn)` passes transaction via context; repos check context for active tx
- **Cursor pagination**: Base64-encoded `sortValue|entryID` for keyset pagination
- **Soft delete**: Entries use `deleted_at` with restore capability

### Domain

Core entity chain: **Entry** → Senses → Translations/Examples. Entries link to **RefEntry** (reference catalog data), **Card** (SRS state), **Topics**, and **UserImages**.

Card states: `NEW → LEARNING → REVIEW → MASTERED` with configurable SRS parameters (ease factor, intervals, learning steps).

Sentinel errors in `domain/errors.go`: `ErrNotFound`, `ErrAlreadyExists`, `ErrValidation`, `ErrUnauthorized`, `ErrForbidden`, `ErrConflict`. Repos map pgx errors to these.

### Code Generation

- **gqlgen**: `go generate ./...` regenerates `internal/transport/graphql/generated/`. Config in `gqlgen.yml` autobinds domain types.
- **sqlc**: `make generate` finds all `sqlc.yaml` files under `internal/adapter/postgres/` and generates type-safe query code.
- After changing `.graphql` schema files or SQL queries, always run `make generate`.

### E2E Tests

Build tag `e2e`. Use testcontainers for PostgreSQL. Full server instantiation with real DB. Run via `make test-e2e`.

### Config

Environment variables override `config.yaml` values. Sensitive config (DSN, JWT secret, OAuth credentials) loaded from ENV only. See `.env.example` for all variables.
