# Фаза 1: Система изучения и повторения

Сейчас в проекте уже реализован основной функционал. Теперь его нужно тюнить под мои реальные потребности.

Первым делом нужно заняться системой повторения. Система повторения и изучения новых слов должна стать основным функционалом приложения. Хранение и коллекционирование новых слов это полезно и круто, но реально пользоваться этим приложением я буду тогда, когда мне будет интересно и полезно заходить в него, чтобы учить английский. Поэтому на первом этапе все фичи должны быть связаны с опытом изучения.

---

## 1. Ревью системы изучения и карточек повторения

### Вердикт: переписывать не нужно, нужно доработать

Архитектура чистая и расширяемая: model → repository → service → resolver. Код хорошо структурирован, есть транзакции, DataLoader для N+1, индексы в БД. Можно развивать то, что есть.

### Как устроена система сейчас

**Модель Card** (`internal/model/model.go`):
- Связь 1:1 с DictionaryEntry через `entry_id` (UNIQUE constraint)
- Поля SRS: `status`, `next_review_at`, `interval_days`, `ease_factor`
- Статусы: NEW → LEARNING → REVIEW → MASTERED

**Алгоритм SM-2** (`internal/service/study/srs.go`):
- Чистая функция `calculateSRS(card, grade, now)` — без побочных эффектов, легко тестировать
- 4 оценки: AGAIN / HARD / GOOD / EASY

| Оценка | Что происходит с интервалом | Ease Factor | Следующий повтор |
|--------|----------------------------|-------------|------------------|
| AGAIN  | сброс в 0                  | EF - 0.2    | через 10 минут   |
| HARD   | × 1.2                      | EF - 0.15   | через N дней     |
| GOOD   | × EF (цепочка: 0→1→3→EF×i)| без изменений | через N дней   |
| EASY   | × EF × 1.3                 | EF + 0.15   | через N дней     |

**Очередь карточек** (`internal/database/repository/cards/cards.go`):
- `GetDueCards`: выбирает карточки где `status = NEW` ИЛИ `next_review_at <= now`
- Приоритет: сначала NEW, затем самые просроченные
- Используются индексы `(status, next_review_at)`

**Процесс повторения** (`internal/service/study/service.go`):
- `ReviewCard`: блокировка `FOR UPDATE` → расчёт SRS → обновление карточки → запись в `review_logs` — всё в одной транзакции
- `GetStudyQueue`: получает карточки к повторению → загружает полные DictionaryEntry

**Фронтенд** (`frontend-playground/src/pages/Study.tsx`):
- Запрос 20 карточек через `GET_STUDY_QUEUE`
- Flip-анимация карточки (слово → определения + переводы + примеры)
- Оценка: кнопки, клавиши 1-4, свайпы
- Экран статистики после завершения сессии

**БД** (таблицы `cards`, `review_logs`, `hints`):
- `cards` — SRS параметры, связь с `dictionary_entries`
- `review_logs` — полная история повторений (grade, duration_ms, reviewed_at)
- `hints` — таблица уже создана, но не подключена к коду

### Что нужно изменить

#### Критичные проблемы алгоритма
- [ ] Нет верхней границы интервала — может вырасти до сотен дней. Добавить max interval (365 дней)
- [ ] Статус MASTERED не используется в алгоритме — карточки никогда не переходят в этот статус. Определить условия перехода (например, interval >= 90 дней И ease_factor >= 2.5)
- [ ] Магические числа захардкожены (1.2, 0.15, 0.2, 1.3) — вынести в именованные константы, в будущем в конфигурацию
- [ ] Потеря точности при `int(float64(interval) * easeFactor)` — дробная часть отбрасывается

#### Настройки и лимиты
- [ ] Нет настроек пользователя — все параметры зашиты в константы (`DefaultDueCardsLimit = 10`, `DefaultEaseFactor = 2.5`). Нужна таблица `user_settings` или хотя бы конфигурация через переменные окружения
- [ ] Нет daily limits — нельзя ограничить количество новых карточек и повторений в день
- [ ] Жёсткий лимит 20 карточек на сессию на фронтенде — нет возможности настроить

#### Аналитика и прогресс
- [ ] Нет концепции сессий изучения — нельзя отследить streak, нет группировки повторений
- [ ] Нет DataLoader для ReviewHistory — потенциальная N+1 проблема при запросе списка карточек с историей
- [ ] GetStudyQueue делает 2 запроса вместо JOIN

#### UX фронтенда
- [ ] Нет возможности пропустить карточку
- [ ] Нет кнопки "назад" к предыдущей карточке
- [ ] Нет паузы сессии
- [ ] Время ответа считается с момента загрузки карточки, а не с переворота
- [ ] Нет визуализации прогресса отдельного слова (график повторений)

---

## 2. Подсказки к карточкам

### Текущее состояние

Таблица `hints` уже создана в БД (`migrations/20260105000000_init_schema.sql`):
```sql
CREATE TABLE hints (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  card_id UUID NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
  text TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

Модель `Hint` существует в `internal/model/model.go`. Но репозиторий, сервис, GraphQL API и фронтенд **не реализованы**.

### Что нужно сделать

#### Backend
- [ ] Создать репозиторий `HintRepository` (CRUD операции)
- [ ] Добавить сервисный метод для управления подсказками
- [ ] Добавить в GraphQL схему: тип `Hint`, мутации `addHint`, `updateHint`, `deleteHint`
- [ ] Добавить поле `hints` в тип `Card` (с DataLoader для батчинга)
- [ ] Реализовать резолверы

#### Frontend
- [ ] Добавить кнопку "Подсказка" на карточке при изучении (показывается после переворота или до)
- [ ] UI для добавления/редактирования подсказки (из страницы AllCards или из словаря)
- [ ] Отображение подсказки в StudyCard — по нажатию, не автоматически

#### Влияние на оценку (отложено)
На первом этапе — не учитывать при выставлении оценки. В будущем:
- Если пользователь использовал подсказку, автоматически ограничить максимальную оценку до GOOD
- Или добавить отдельный флаг `used_hint` в `review_logs`

---

## 3. Разные режимы повторения

Переходить только после стабилизации пунктов 1 и 2.

### Возможные режимы
- **Классический** (текущий): показать слово → вспомнить определение/перевод
- **Обратный**: показать определение/перевод → вспомнить слово
- **Аудио**: воспроизвести произношение → вспомнить слово
- **Ввод**: набрать слово вручную (по определению или переводу)
- **Контекст**: показать пример с пропущенным словом → вспомнить слово

### Архитектурные соображения
- Режим — параметр сессии, а не карточки
- Результат повторения сохраняется одинаково для всех режимов
- Некоторые режимы требуют наличия данных (аудио — pronunciations, контекст — examples)
- Можно комбинировать режимы в рамках одной сессии

---

## Ключевые файлы

### Backend
| Файл | Описание |
|------|----------|
| `internal/model/model.go` | Модели Card, ReviewLog, Hint |
| `internal/model/enums.go` | LearningStatus, ReviewGrade |
| `internal/service/study/srs.go` | Алгоритм SM-2 |
| `internal/service/study/service.go` | Бизнес-логика: ReviewCard, GetStudyQueue |
| `internal/service/card/service.go` | CRUD карточек |
| `internal/database/repository/cards/cards.go` | SQL: GetDueCards, UpdateSRSFields, DashboardStats |
| `internal/database/repository/interfaces.go` | Контракты репозиториев |
| `graph/schema.graphqls` | GraphQL схема: Card, ReviewLog, studyQueue, reviewCard |
| `graph/schema.resolvers.go` | Резолверы |
| `internal/transport/dataloader/` | DataLoader для Card |
| `migrations/20260105000000_init_schema.sql` | Таблицы cards, review_logs, hints |

### Frontend
| Файл | Описание |
|------|----------|
| `src/pages/Study.tsx` | Страница изучения: очередь, оценка, сессия |
| `src/pages/AllCards.tsx` | Список всех карточек с фильтрацией и статистикой |
| `src/components/study/StudyCard.tsx` | Карточка с flip-анимацией |
| `src/components/study/StudyGradeButtons.tsx` | Кнопки оценки |
| `src/components/study/StudyComplete.tsx` | Экран завершения сессии |
| `src/components/study/StudyProgress.tsx` | Прогресс-бар |
| `src/graphql/queries.ts` | GraphQL запросы и мутации |
| `src/hooks/use-swipe.ts` | Свайп-жесты |
